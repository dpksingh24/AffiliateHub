{% assign wishlist_page_url = '/pages/affiliate-dashboard#wishlist' %}
{% assign aria_label = 'My wishlist' %}
{% assign icon_size = 22 %}
{% assign show_count = false %}
{% assign login_url = '/account' %}

<script id="ks-wishlist-sidebar-config" type="application/json">
  {
    "shop": "{{ shop.permanent_domain }}",
    "customerId": "{% if customer %}{{ customer.id }}{% endif %}",
    "apiBaseUrl": "https://kisciapp.ebizonstg.com",
    "wishlistPageUrl": "{{ wishlist_page_url }}",
    "loginUrl": "{{ login_url }}"
  }
</script>

  <div id="ks-wishlist-embed-root" class="ks-wishlist-embed site-header-wishlist site-header__wishlist" style="display: none;">
    <button type="button" id="ks-wishlist-header-trigger" class="ks-wishlist-header site-header__icon" aria-label="{{ aria_label }}" aria-expanded="false" aria-controls="ks-wishlist-sidebar">
      <svg class="ks-wishlist-header__icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" focusable="false"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      <span class="ks-wishlist-header__count" id="ks-wishlist-header-count" data-ks-wishlist-count aria-hidden="true"></span>
    </button>
  </div>

  <div id="ks-wishlist-sidebar-overlay" class="ks-wishlist-sidebar-overlay" aria-hidden="true" style="display: none;"></div>
  <aside id="ks-wishlist-sidebar" class="ks-wishlist-sidebar" role="dialog" aria-label="Wishlist" aria-modal="true" aria-hidden="true" style="display: none;">
    <div class="ks-wishlist-sidebar__inner">
      <header class="ks-wishlist-sidebar__header">
        <h2 class="ks-wishlist-sidebar__title">Wishlist</h2>
        <button type="button" class="ks-wishlist-sidebar__close" aria-label="Close wishlist">&times;</button>
      </header>
      <div class="ks-wishlist-sidebar__content">
        <div id="ks-wishlist-sidebar-items" class="ks-wishlist-sidebar__items">
          <p class="ks-wishlist-sidebar__loading">Loading wishlist…</p>
        </div>
      </div>
    </div>
  </aside>

  <style>
#ks-wishlist-header-placeholder{display:inline-flex!important;visibility:visible!important;align-items:center;margin-right:0;padding-right:0}.site-header-right,.header__secondary,.header-right,.header-actions,.header__icons{padding-right:12px!important}#ks-wishlist-embed-root.ks-wishlist-embed,.ks-wishlist-embed.site-header-wishlist{display:inline-flex!important;visibility:visible!important;align-items:center;vertical-align:middle;margin-left:0;margin-right:0}.ks-wishlist-embed .ks-wishlist-header{display:inline-flex!important;visibility:visible!important;align-items:center;justify-content:center;padding:0;margin:0;min-width:44px;min-height:44px;color:#fff;text-decoration:none;border:none;background:#fff0;cursor:pointer;transition:opacity .15s ease,color .15s ease}.ks-wishlist-embed .ks-wishlist-header:hover{opacity:.8;color:currentColor}.ks-wishlist-embed .ks-wishlist-header__icon{display:inline-block!important;width:22px;height:22px;flex-shrink:0;color:inherit;visibility:visible!important}.ks-wishlist-embed .ks-wishlist-header__count{display:none;margin-left:4px;margin-bottom:10px;font-size:15px;font-weight:600;text-align:center;color:#000}.ks-wishlist-embed .ks-wishlist-header button{background:none;border:none}.ks-wishlist-sidebar-overlay{position:fixed;inset:0;background:rgb(0 0 0 / .4);z-index:9998;opacity:0;transition:opacity .25s ease}.ks-wishlist-sidebar-overlay.is-open{opacity:1}.ks-wishlist-sidebar{position:fixed;top:0;right:0;width:100%;max-width:380px;height:100%;background:#fff;z-index:9999;box-shadow:-4px 0 20px rgb(0 0 0 / .15);transition:transform .3s ease;overflow:hidden}.ks-wishlist-sidebar.is-open{transform:translateX(0)}.ks-wishlist-sidebar__inner{display:flex;flex-direction:column;height:100%}.ks-wishlist-sidebar__header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #eee;flex-shrink:0}.ks-wishlist-sidebar__title{margin:0;font-size:1.25rem;font-weight:600}.ks-wishlist-sidebar__close{background:none;border:none;font-size:1.5rem;line-height:1;cursor:pointer;padding:4px;color:#333}.ks-wishlist-sidebar__close:hover{opacity:.7}.ks-wishlist-sidebar__content{flex:1;overflow-y:auto;padding:12px}.ks-wishlist-sidebar__items{min-height:80px}.ks-wishlist-sidebar__loading,.ks-wishlist-sidebar__empty{margin:0;padding:16px 0;color:#666;text-align:center}.ks-wishlist-sidebar-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #f0f0f0}.ks-wishlist-sidebar-item:last-child{border-bottom:none}.ks-wishlist-sidebar-item__img{width:64px;height:64px;object-fit:cover;flex-shrink:0;background:#f5f5f5}.ks-wishlist-sidebar-item__img--placeholder{display:flex;align-items:center;justify-content:center;font-size:10px;color:#999}.ks-wishlist-sidebar-item__body{flex:1;min-width:0}.ks-wishlist-sidebar-item__title{margin:0 0 4px;font-size:.9rem;font-weight:500;line-height:1.3}.ks-wishlist-sidebar-item__title a{color:inherit;text-decoration:none}.ks-wishlist-sidebar-item__title a:hover{text-decoration:underline}.ks-wishlist-sidebar-item__price{font-size:.9rem;font-weight:600;margin-bottom:8px}.ks-wishlist-sidebar-item__actions{display:flex;gap:8px;flex-wrap:wrap}.ks-wishlist-sidebar-item__btn{padding:6px 12px;font-size:.8rem;border-radius:4px;cursor:pointer;border:1px solid #ddd;background:#fff;color:#333}.ks-wishlist-sidebar-item__btn:hover{background:#f5f5f5}.ks-wishlist-sidebar-item__btn--cart{background:#333;color:#fff;border-color:#333}.ks-wishlist-sidebar-item__btn--cart:hover{background:#555}.ks-wishlist-sidebar__footer{padding:16px 20px;border-top:1px solid #eee;flex-shrink:0}.ks-wishlist-sidebar__link{display:block;text-align:center;padding:10px;color:#333;text-decoration:none;font-weight:500;border:1px solid #333;border-radius:4px}.ks-wishlist-sidebar__link:hover{background:#f5f5f5}.ks-wishlist-sidebar__guest{padding:24px 0;text-align:center}.ks-wishlist-sidebar__guest-message{margin:0 0 20px;color:#555;font-size:.95rem;line-height:1.5}.ks-wishlist-sidebar__guest-btn{display:inline-block;padding:12px 24px;font-size:1rem;font-weight:500;color:#fff;background:#333;border:1px solid #333;border-radius:4px;text-decoration:none;cursor:pointer;transition:background .15s ease}.ks-wishlist-sidebar__guest-btn:hover{background:#555;color:#fff}
  </style>

  <div id="ks-wishlist-collection-config" style="display: none;" data-shop="{{ shop.permanent_domain }}" data-customer-id="{% if customer %}{{ customer.id }}{% endif %}" data-api-base="{{ shop.metafields.kiscience.app_proxy_url | default: '/apps/kiscience' }}"></div>
  <style>
    .ks-wishlist-collection-icon-wrap { position: absolute; top: 10px; right: 10px; z-index: 2; }
    .ks-wishlist-collection-icon { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.08); border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1; transition: background 0.2s, transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .ks-wishlist-collection-icon:hover { background: #fff; transform: scale(1.05); }
    .ks-wishlist-collection-icon:disabled { opacity: 0.7; cursor: wait; }
    .ks-wishlist-collection-icon.ks-wishlist-collection-icon--added { color: #dc2626; }
    .ks-wishlist-collection-card-hint { position: relative; }
  </style>
  <script>
    (function() {
      var configEl = document.getElementById('ks-wishlist-collection-config');
      if (!configEl && document.querySelector('.site-header__wishlist-placeholder, .site-header_wishlist-placeholder, [id="ks-wishlist-header-placeholder"]')) {
        var shop = (typeof window.Shopify !== 'undefined' && window.Shopify.shop) ? window.Shopify.shop : (document.documentElement.getAttribute('data-shop') || '');
        configEl = { getAttribute: function(k) { if (k === 'data-shop') return shop; if (k === 'data-customer-id') return ''; if (k === 'data-api-base') return '/apps/kiscience'; return null; } };
      }
      if (!configEl) return;
      var shop = (configEl.getAttribute('data-shop') || '').trim();
      var customerId = (configEl.getAttribute('data-customer-id') || '').trim();
      var apiBase = (configEl.getAttribute('data-api-base') || '/apps/kiscience').replace(/\/$/, '');
      var cardSelectors = '.card-wrapper, .product-card, .product-card-wrapper, [class*="product-card"], [class*="card--"], .productgrid--item, .productitem, .product-item, .productitem_container, [class*="productgrid--item"]';
      function getProductIdFromCard(card) {
        if (!card) return null;
        var el = card.querySelector('[data-product-id]');
        if (el) return el.getAttribute('data-product-id');
        if (card.getAttribute('data-product-id')) return card.getAttribute('data-product-id');
        el = card.querySelector('[data-product_id]');
        if (el) return el.getAttribute('data-product_id');
        if (card.getAttribute('data-product_id')) return card.getAttribute('data-product_id');
        var link = card.querySelector('a[href*="/products/"]');
        if (link) {
          if (link.getAttribute('data-product-id')) return link.getAttribute('data-product-id');
          var href = link.getAttribute('href') || '';
          var m = href.match(/\/products\/([^?#/]+)/);
          if (m) return m[1];
        }
        el = card.querySelector('input[name="product_id"], input[name="product-id"], [data-product-id]');
        if (el) return el.getAttribute('data-product-id') || el.getAttribute('value') || el.value;
        return null;
      }
      function getProductCards() {
        var cards = [];
        document.querySelectorAll('[data-product-id]').forEach(function(el) {
          if (el.closest('.ks-wishlist-collection-icon-wrap')) return;
          var id = el.getAttribute('data-product-id');
          if (!id) return;
          var card = el.closest(cardSelectors) || el;
          if (card && card.closest && !card.closest('.ks-wishlist-collection-icon-wrap') && !cards.some(function(c) { return c.card === card; })) cards.push({ card: card, productId: id });
        });
        if (cards.length > 0) return cards;
        document.querySelectorAll('a[href*="/products/"]').forEach(function(a) {
          var card = a.closest(cardSelectors) || a.parentElement;
          if (!card || card.querySelector('[data-ks-wishlist-collection-id]')) return;
          var productId = getProductIdFromCard(card);
          if (productId && !cards.some(function(c) { return c.card === card; })) cards.push({ card: card, productId: productId });
        });
        return cards;
      }
      var placeholderSelectors = '.site-header__wishlist-placeholder, .site-header_wishlist-placeholder, [id="ks-wishlist-header-placeholder"]';
      function getPlaceholderTargets() {
        var out = [];
        document.querySelectorAll(placeholderSelectors).forEach(function(placeholder) {
          if (placeholder.querySelector('.ks-wishlist-collection-icon') || placeholder.querySelector('[data-ks-wishlist-collection-id]')) return;
          if (placeholder.closest('header') || placeholder.closest('.header') || placeholder.closest('.site-header')) return;
          var card = placeholder.closest('.productgrid--item') || placeholder.closest('.productitem') || placeholder.closest('.productitem_container') || placeholder.closest(cardSelectors);
          if (!card) return;
          var productId = getProductIdFromCard(card);
          if (!productId) return;
          if (out.some(function(o) { return o.placeholder === placeholder; })) return;
          out.push({ placeholder: placeholder, card: card, productId: productId });
        });
        return out;
      }
      function handleIconClick(e) {
        var btn = e.target.closest('.ks-wishlist-collection-icon');
        if (!btn || btn.disabled) return;
        e.preventDefault();
        e.stopPropagation();
        if (!customerId) {
          if (typeof window.ksWishlistOpenSidebar === 'function') window.ksWishlistOpenSidebar();
          return;
        }
        var productId = btn.getAttribute('data-product-id');
        if (!productId || !shop) return;
        var isAdded = btn.classList.contains('ks-wishlist-collection-icon--added');
        btn.disabled = true;
        var url = apiBase + '/api/customers/wishlist?shop=' + encodeURIComponent(shop) + '&customerId=' + encodeURIComponent(customerId) + '&productId=' + encodeURIComponent(String(productId));
        var opts = { credentials: 'same-origin', headers: { 'Accept': 'application/json' } };
        if (isAdded) {
          opts.method = 'DELETE';
        } else {
          opts.method = 'POST';
          opts.headers['Content-Type'] = 'application/json';
          opts.body = JSON.stringify({ shop: shop, customerId: customerId, productId: String(productId) });
        }
        fetch(isAdded ? url : apiBase + '/api/customers/wishlist', opts)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success) {
              var heart = btn.querySelector('.ks-wishlist-collection-icon__heart');
              if (isAdded) {
                if (heart) heart.textContent = '\u2661';
                btn.classList.remove('ks-wishlist-collection-icon--added');
                btn.setAttribute('aria-label', 'Add to wishlist');
              } else {
                if (heart) heart.textContent = '\u2665';
                btn.classList.add('ks-wishlist-collection-icon--added');
                btn.setAttribute('aria-label', 'Remove from wishlist');
              }
              try { window.dispatchEvent(new CustomEvent('kiscience:wishlist-updated')); } catch (err) {}
            }
          })
          .catch(function() {})
          .finally(function() { btn.disabled = false; });
      }
      function createIcon(productId) {
        var wrap = document.createElement('div');
        wrap.className = 'ks-wishlist-collection-icon-wrap';
        wrap.setAttribute('data-ks-wishlist-collection-id', productId);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ks-wishlist-collection-icon';
        btn.setAttribute('aria-label', 'Add to wishlist');
        btn.setAttribute('data-product-id', productId);
        btn.innerHTML = '<span class="ks-wishlist-collection-icon__heart" aria-hidden="true">&#9825;</span>';
        wrap.appendChild(btn);
        return wrap;
      }
      function injectIcons() {
        var injectedCards = new Set();
        function injectIntoCard(item, targetEl) {
          if (!targetEl || targetEl.querySelector('.ks-wishlist-collection-icon')) return;
          item.card.classList.add('ks-wishlist-collection-card-hint');
          var icon = createIcon(item.productId);
          targetEl.appendChild(icon);
          injectedCards.add(item.card);
        }
        getPlaceholderTargets().forEach(function(item) {
          if (item.placeholder.querySelector('.ks-wishlist-collection-icon')) return;
          injectIntoCard(item, item.placeholder);
        });
        getProductCards().forEach(function(item) {
          if (injectedCards.has(item.card)) return;
          if (item.card.querySelector('[data-ks-wishlist-collection-id]') || item.card.querySelector('.ks-wishlist-collection-icon')) return;
          var placeholderInCard = item.card.querySelector(placeholderSelectors);
          var targetEl = placeholderInCard || item.card.querySelector('.card__media, .product-card__image, [class*="media"], [class*="image"], [class*="image-container"], [class*="productitem__image"]') || item.card;
          injectIntoCard(item, targetEl);
        });
      }
      if (!window.__ksWishlistCollectionClickBound) {
        window.__ksWishlistCollectionClickBound = true;
        document.body.addEventListener('click', handleIconClick, true);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { injectIcons(); retryInject(); });
      } else {
        injectIcons();
        retryInject();
      }
      function retryInject() {
        setTimeout(function() { injectIcons(); }, 500);
        setTimeout(function() { injectIcons(); }, 1500);
      }
    })();
  </script>

  <script>
    (function() {
      var configEl = document.getElementById('ks-wishlist-sidebar-config');
      var config = configEl ? JSON.parse(configEl.textContent) : {};
      var apiBase = config.apiBaseUrl || (window.KiscienceConfig && window.KiscienceConfig.appApiBaseUrl) || 'https://kisciapp.ebizonstg.com';
      var shop = config.shop || (window.KiscienceConfig && window.KiscienceConfig.shop) || '';
      var customerId = config.customerId || (window.KiscienceConfig && window.KiscienceConfig.customerId) || '';

      function updateHeaderCount(count) {
        var el = document.getElementById('ks-wishlist-header-count');
        if (!el) return;
        if (count == null || count < 1) {
          el.textContent = '';
          el.style.display = 'none';
        } else {
          el.textContent = count > 99 ? '99+' : String(count);
          el.style.display = 'inline-block';
        }
      }

      function openSidebar() {
        var overlay = document.getElementById('ks-wishlist-sidebar-overlay');
        var sidebar = document.getElementById('ks-wishlist-sidebar');
        if (overlay) { overlay.style.display = 'block'; overlay.classList.add('is-open'); }
        if (sidebar) {
          sidebar.style.display = 'block';
          sidebar.classList.add('is-open');
          sidebar.setAttribute('aria-hidden', 'false');
        }
        var trigger = document.getElementById('ks-wishlist-header-trigger');
        if (trigger) trigger.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        if (!customerId) {
          showGuestWishlistSidebar();
        } else {
          loadSidebarWishlist();
        }
      }

      function showGuestWishlistSidebar() {
        var container = document.getElementById('ks-wishlist-sidebar-items');
        if (!container) return;
        var loginUrl = (config.loginUrl || '/account').replace(/"/g, '&quot;');
        container.innerHTML =
          '<div class="ks-wishlist-sidebar__guest">' +
          '<p class="ks-wishlist-sidebar__guest-message">Log in to save products to your wishlist and see them here.</p>' +
          '<a href="' + loginUrl + '" class="ks-wishlist-sidebar__guest-btn ks-btn">Log in</a>' +
          '</div>';
      }

      function closeSidebar() {
        var overlay = document.getElementById('ks-wishlist-sidebar-overlay');
        var sidebar = document.getElementById('ks-wishlist-sidebar');
        if (overlay) { overlay.classList.remove('is-open'); overlay.style.display = 'none'; }
        if (sidebar) {
          sidebar.classList.remove('is-open');
          sidebar.setAttribute('aria-hidden', 'true');
          sidebar.style.display = 'none';
        }
        var trigger = document.getElementById('ks-wishlist-header-trigger');
        if (trigger) trigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      function loadSidebarWishlist() {
        var container = document.getElementById('ks-wishlist-sidebar-items');
        if (!container) return;
        container.innerHTML = '<p class="ks-wishlist-sidebar__loading">Loading wishlist…</p>';
        var url = apiBase + '/api/customers/wishlist?shop=' + encodeURIComponent(shop) + '&customerId=' + encodeURIComponent(customerId);
        fetch(url, { credentials: 'include' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var items = (data && data.items) ? data.items : [];
            updateHeaderCount(items.length);
            if (items.length === 0) {
              container.innerHTML = '<p class="ks-wishlist-sidebar__empty">Your wishlist is empty. Add products from the shop to see them here.</p>';
              return;
            }
            container.innerHTML = items.map(function(item) {
              var id = item.id != null ? String(item.id) : (item.handle || '');
              var url = item.url || '/products/' + (item.handle || '');
              var name = (item.title || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
              var price = item.price != null ? item.price : '';
              var img = item.image;
              var imgHtml = img
                ? '<img src="' + img.replace(/"/g, '&quot;') + '" alt="" class="ks-wishlist-sidebar-item__img" loading="lazy">'
                : '<div class="ks-wishlist-sidebar-item__img ks-wishlist-sidebar-item__img--placeholder">No image</div>';
              var variantId = item.variant_id != null && item.variant_id !== '' ? String(item.variant_id) : '';
              return (
                '<div class="ks-wishlist-sidebar-item" data-product-id="' + id.replace(/"/g, '&quot;') + '">' +
                  '<a href="' + url.replace(/"/g, '&quot;') + '" class="ks-wishlist-sidebar-item__img-wrap">' + imgHtml + '</a>' +
                  '<div class="ks-wishlist-sidebar-item__body">' +
                    '<h3 class="ks-wishlist-sidebar-item__title"><a href="' + url.replace(/"/g, '&quot;') + '">' + name + '</a></h3>' +
                    '<p class="ks-wishlist-sidebar-item__price">' + (price ? String(price).replace(/</g, '&lt;') : '') + '</p>' +
                    '<div class="ks-wishlist-sidebar-item__actions">' +
                      (variantId ? '<button type="button" class="ks-wishlist-sidebar-item__btn ks-wishlist-sidebar-item__btn--cart" data-variant-id="' + variantId.replace(/"/g, '&quot;') + '">Add to cart</button>' : '<a href="' + url.replace(/"/g, '&quot;') + '" class="ks-wishlist-sidebar-item__btn">View product</a>') +
                      '<button type="button" class="ks-wishlist-sidebar-item__btn ks-wishlist-sidebar-item__btn--remove" data-product-id="' + id.replace(/"/g, '&quot;') + '">Remove</button>' +
                    '</div>' +
                  '</div>' +
                '</div>'
              );
            }).join('');
            container.querySelectorAll('.ks-wishlist-sidebar-item__btn--cart').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var vid = this.getAttribute('data-variant-id');
                if (!vid) return;
                var root = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) ? window.Shopify.routes.root : '/';
                var base = root.endsWith('/') ? root : root + '/';
                var addUrl = base + 'cart/add.js';
                fetch(addUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                  body: JSON.stringify({ items: [{ id: vid, quantity: 1 }] })
                }).then(function(r) { return r.json(); }).then(function(res) {
                  if (res.status && res.status !== 200) alert(res.description || 'Could not add to cart');
                  else {
                    closeSidebar();
                    window.location.href = base + 'cart';
                  }
                }).catch(function() { alert('Could not add to cart'); });
              });
            });
            container.querySelectorAll('.ks-wishlist-sidebar-item__btn--remove').forEach(function(btn) {
              btn.addEventListener('click', function() {
                var pid = this.getAttribute('data-product-id');
                if (!pid) return;
                var row = this.closest('.ks-wishlist-sidebar-item');
                var url = apiBase + '/api/customers/wishlist?shop=' + encodeURIComponent(shop) + '&customerId=' + encodeURIComponent(customerId) + '&productId=' + encodeURIComponent(pid);
                fetch(url, { method: 'DELETE', credentials: 'include' })
                  .then(function(r) { return r.json(); })
                  .then(function(data) {
                    if (data && data.success && row) row.remove();
                    var remaining = container.querySelectorAll('.ks-wishlist-sidebar-item');
                    updateHeaderCount(remaining.length);
                    if (remaining.length === 0) container.innerHTML = '<p class="ks-wishlist-sidebar__empty">Your wishlist is empty.</p>';
                  });
              });
            });
          })
          .catch(function() {
            container.innerHTML = '<p class="ks-wishlist-sidebar__empty">Could not load wishlist. <a href="' + (config.wishlistPageUrl || '/pages/affiliate-dashboard#wishlist') + '">View wishlist page</a></p>';
            updateHeaderCount(0);
          });
      }

      function fetchWishlistCountOnInit() {
        if (!customerId) {
          updateHeaderCount(0);
          return;
        }
        var url = apiBase + '/api/customers/wishlist?shop=' + encodeURIComponent(shop) + '&customerId=' + encodeURIComponent(customerId);
        fetch(url, { credentials: 'include' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var items = (data && data.items) ? data.items : [];
            updateHeaderCount(items.length);
          })
          .catch(function() { updateHeaderCount(0); });
      }

      function injectWishlistIntoHeader() {
        var root = document.getElementById('ks-wishlist-embed-root');
        if (!root) return;

        var header = document.querySelector('header, .header, [data-section-type="header"], #shopify-section-header, .site-header, .main-header');
        var placeholder = header ? header.querySelector('.site-header__wishlist-placeholder, .site-header_wishlist-placeholder, #ks-wishlist-header-placeholder') : null;
        if (!placeholder) placeholder = document.getElementById('ks-wishlist-header-placeholder');
        if (placeholder && (!header || header.contains(placeholder))) {
          placeholder.appendChild(root);
          placeholder.style.display = 'inline-flex';
          placeholder.style.visibility = 'visible';
          root.style.display = 'inline-flex';
          root.style.visibility = 'visible';
          fetchWishlistCountOnInit();
          return;
        }

        if (!header) return;

        var inserted = false;

        var searchSelectors = [
          'input[type="search"]',
          '.header__search',
          '.search-form',
          '[data-search]',
          'form[action*="/search"]',
          '.header-search',
          '.search-bar'
        ];
        for (var i = 0; i < searchSelectors.length; i++) {
          var searchEl = header.querySelector(searchSelectors[i]);
          if (searchEl) {
            var searchParent = searchEl.parentElement;
            if (searchParent) {
              searchParent.insertBefore(root, searchEl);
              inserted = true;
              break;
            }
          }
        }

        if (!inserted) {
          var cartSelectors = [
            'a[href*="/cart"]',
            '.header__icon--cart',
            '.cart-icon',
            '[data-cart-icon]',
            '.cart-count-bubble',
            '.header-cart'
          ];
          for (var j = 0; j < cartSelectors.length; j++) {
            var cartEl = header.querySelector(cartSelectors[j]);
            if (cartEl) {
              var cartParent = cartEl.parentElement;
              if (cartParent) {
                cartParent.insertBefore(root, cartEl);
                inserted = true;
                break;
              }
            }
          }
        }

        if (!inserted) {
          var rightSlot = header.querySelector('.header__icons, .header-icons, .header-actions, .header__secondary, .header-right');
          if (rightSlot) {
            rightSlot.insertBefore(root, rightSlot.firstChild);
            inserted = true;
          }
        }

        if (!inserted) {
          header.appendChild(root);
        }
        root.style.display = 'inline-flex';
        root.style.visibility = 'visible';
        fetchWishlistCountOnInit();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectWishlistIntoHeader);
      } else {
        injectWishlistIntoHeader();
      }
      window.addEventListener('load', function() {
        var root = document.getElementById('ks-wishlist-embed-root');
        if (root && (root.style.display === 'none' || root.style.display === '')) {
          injectWishlistIntoHeader();
        }
      });
      setTimeout(function() {
        var root = document.getElementById('ks-wishlist-embed-root');
        if (root && (root.style.display === 'none' || root.style.display === '')) {
          injectWishlistIntoHeader();
        }
      }, 800);

      document.body.addEventListener('click', function(e) {
        if (e.target.closest('#ks-wishlist-header-trigger')) {
          e.preventDefault();
          openSidebar();
        }
        if (e.target.id === 'ks-wishlist-sidebar-overlay' || e.target.closest('.ks-wishlist-sidebar__close')) {
          closeSidebar();
        }
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeSidebar();
      });
      window.addEventListener('kiscience:wishlist-updated', function() {
        fetchWishlistCountOnInit();
      });
      window.ksWishlistOpenSidebar = openSidebar;
    })();
  </script>

{% schema %}
{
  "name": "Wishlist",
  "target": "body"
}
{% endschema %}
