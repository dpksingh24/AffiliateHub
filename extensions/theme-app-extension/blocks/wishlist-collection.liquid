  <div
    id="ks-wishlist-collection-config"
    style="display: none;"
    data-shop="{{ shop.permanent_domain }}"
    data-customer-id="{% if customer %}{{ customer.id }}{% endif %}"
    data-api-base="{{ shop.metafields.kiscience.app_proxy_url | default: '/apps/kiscience' }}"
  ></div>
  <style>
    .ks-wishlist-collection-icon-wrap {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
    }
    .ks-wishlist-collection-icon { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 50%; cursor: pointer; font-size: 18px; line-height: 1; transition: background 0.2s, transform 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
    .ks-wishlist-collection-icon:hover {
      background: #fff;
      transform: scale(1.05);
    }
    .ks-wishlist-collection-icon:disabled {
      opacity: 0.7;
      cursor: wait;
    }
    .ks-wishlist-collection-icon.ks-wishlist-collection-icon--added {
      color: #dc2626;
    }
    .ks-wishlist-collection-card-hint {
      position: relative;
    }
  </style>
  <script>
    (function() {
      var configEl = document.getElementById('ks-wishlist-collection-config');
      if (!configEl && document.querySelector('.site-header__wishlist-placeholder, .site-header_wishlist-placeholder, [id="ks-wishlist-header-placeholder"]')) {
        var shop = (typeof window.Shopify !== 'undefined' && window.Shopify.shop) ? window.Shopify.shop : (document.documentElement.getAttribute('data-shop') || '');
        configEl = { getAttribute: function(k) { if (k === 'data-shop') return shop; if (k === 'data-customer-id') return ''; if (k === 'data-api-base') return '/apps/kiscience'; return null; } };
      }
      if (!configEl) return;
      var shop = (configEl.getAttribute('data-shop') || '').trim();
      var customerId = (configEl.getAttribute('data-customer-id') || '').trim();
      var apiBase = (configEl.getAttribute('data-api-base') || '/apps/kiscience').replace(/\/$/, '');

      var cardSelectors = '.card-wrapper, .product-card, .product-card-wrapper, [class*="product-card"], [class*="card--"], .productgrid--item, .productitem, .product-item, .productitem_container, [class*="productgrid--item"]';

      function getProductIdFromCard(card) {
        if (!card) return null;
        var el = card.querySelector('[data-product-id]');
        if (el) return el.getAttribute('data-product-id');
        if (card.getAttribute('data-product-id')) return card.getAttribute('data-product-id');
        el = card.querySelector('[data-product_id]');
        if (el) return el.getAttribute('data-product_id');
        if (card.getAttribute('data-product_id')) return card.getAttribute('data-product_id');
        var link = card.querySelector('a[href*="/products/"]');
        if (link) {
          if (link.getAttribute('data-product-id')) return link.getAttribute('data-product-id');
          var href = link.getAttribute('href') || '';
          var m = href.match(/\/products\/([^?#/]+)/);
          if (m) return m[1];
        }
        el = card.querySelector('input[name="product_id"], input[name="product-id"], [data-product-id]');
        if (el) return el.getAttribute('data-product-id') || el.getAttribute('value') || el.value;
        return null;
      }

      function getProductCards() {
        var cards = [];
        var byDataId = document.querySelectorAll('[data-product-id]');
        byDataId.forEach(function(el) {
          if (el.closest('.ks-wishlist-collection-icon-wrap')) return;
          var id = el.getAttribute('data-product-id');
          if (!id) return;
          var card = el.closest(cardSelectors) || el;
          if (card && card.closest && !card.closest('.ks-wishlist-collection-icon-wrap') && !cards.some(function(c) { return c.card === card; })) {
            cards.push({ card: card, productId: id });
          }
        });
        if (cards.length > 0) return cards;
        var links = document.querySelectorAll('a[href*="/products/"]');
        links.forEach(function(a) {
          var href = a.getAttribute('href') || '';
          var match = href.match(/\/products\/([^?#/]+)/);
          if (!match) return;
          var card = a.closest(cardSelectors) || a.parentElement;
          if (!card) return;
          var existing = card.querySelector('[data-ks-wishlist-collection-id]');
          if (existing) return;
          var productId = getProductIdFromCard(card);
          if (productId && !cards.some(function(c) { return c.card === card; }))
            cards.push({ card: card, productId: productId });
        });
        return cards;
      }

      var placeholderSelectors = '.site-header__wishlist-placeholder, .site-header_wishlist-placeholder, [id="ks-wishlist-header-placeholder"]';
      function getPlaceholderTargets() {
        var out = [];
        var placeholders = document.querySelectorAll(placeholderSelectors);
        placeholders.forEach(function(placeholder) {
          if (placeholder.querySelector('.ks-wishlist-collection-icon') || placeholder.querySelector('[data-ks-wishlist-collection-id]')) return;
          var card = placeholder.closest('.productgrid--item') || placeholder.closest('.productitem') || placeholder.closest('.productitem_container') || placeholder.closest(cardSelectors);
          if (!card) return;
          if (card.closest('header') || card.closest('.header') || card.closest('.site-header')) return;
          var productId = getProductIdFromCard(card);
          if (!productId) return;
          if (out.some(function(o) { return o.placeholder === placeholder; })) return;
          out.push({ placeholder: placeholder, card: card, productId: productId });
        });
        return out;
      }

      function handleIconClick(e) {
        var btn = e.target.closest('.ks-wishlist-collection-icon');
        if (!btn || btn.disabled) return;
        e.preventDefault();
        e.stopPropagation();
        if (!customerId) {
          if (typeof window.ksWishlistOpenSidebar === 'function') window.ksWishlistOpenSidebar();
          return;
        }
        var productId = btn.getAttribute('data-product-id');
        if (!productId || !shop) return;
        var isAdded = btn.classList.contains('ks-wishlist-collection-icon--added');
        btn.disabled = true;
        var url = apiBase + '/api/customers/wishlist?shop=' + encodeURIComponent(shop) + '&customerId=' + encodeURIComponent(customerId) + '&productId=' + encodeURIComponent(String(productId));
        var opts = { credentials: 'same-origin', headers: { 'Accept': 'application/json' } };
        if (isAdded) {
          opts.method = 'DELETE';
        } else {
          opts.method = 'POST';
          opts.headers['Content-Type'] = 'application/json';
          opts.body = JSON.stringify({ shop: shop, customerId: customerId, productId: String(productId) });
        }
        fetch(isAdded ? url : apiBase + '/api/customers/wishlist', opts)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success) {
              var heart = btn.querySelector('.ks-wishlist-collection-icon__heart');
              if (isAdded) {
                if (heart) heart.textContent = '\u2661';
                btn.classList.remove('ks-wishlist-collection-icon--added');
                btn.setAttribute('aria-label', 'Add to wishlist');
              } else {
                if (heart) heart.textContent = '\u2665';
                btn.classList.add('ks-wishlist-collection-icon--added');
                btn.setAttribute('aria-label', 'Remove from wishlist');
              }
              try { window.dispatchEvent(new CustomEvent('kiscience:wishlist-updated')); } catch (err) {}
            }
          })
          .catch(function() {})
          .finally(function() { btn.disabled = false; });
      }

      function createIcon(productId) {
        var wrap = document.createElement('div');
        wrap.className = 'ks-wishlist-collection-icon-wrap';
        wrap.setAttribute('data-ks-wishlist-collection-id', productId);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ks-wishlist-collection-icon';
        btn.setAttribute('aria-label', 'Add to wishlist');
        btn.setAttribute('data-product-id', productId);
        btn.innerHTML = '<span class="ks-wishlist-collection-icon__heart" aria-hidden="true">&#9825;</span>';
        wrap.appendChild(btn);
        return wrap;
      }

      function injectIcons() {
        var injectedCards = new Set();

        function injectIntoCard(item, targetEl) {
          if (!targetEl || targetEl.querySelector('.ks-wishlist-collection-icon')) return;
          item.card.classList.add('ks-wishlist-collection-card-hint');
          var icon = createIcon(item.productId);
          targetEl.appendChild(icon);
          injectedCards.add(item.card);
        }

        var placeholderTargets = getPlaceholderTargets();
        placeholderTargets.forEach(function(item) {
          if (item.placeholder.querySelector('.ks-wishlist-collection-icon')) return;
          injectIntoCard(item, item.placeholder);
        });

        var cards = getProductCards();
        cards.forEach(function(item) {
          if (injectedCards.has(item.card)) return;
          if (item.card.querySelector('[data-ks-wishlist-collection-id]') || item.card.querySelector('.ks-wishlist-collection-icon')) return;
          var placeholderInCard = item.card.querySelector(placeholderSelectors);
          var targetEl = placeholderInCard || item.card.querySelector('.card__media, .product-card__image, [class*="media"], [class*="image"]') || item.card;
          injectIntoCard(item, targetEl);
        });
      }

      if (!window.__ksWishlistCollectionClickBound) {
        window.__ksWishlistCollectionClickBound = true;
        document.body.addEventListener('click', handleIconClick, true);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { injectIcons(); retryInject(); });
      } else {
        injectIcons();
        retryInject();
      }

      function retryInject() {
        setTimeout(function() {
          var placeholders = document.querySelectorAll(placeholderSelectors);
          var empty = 0;
          placeholders.forEach(function(p) {
            if (!p.querySelector('.ks-wishlist-collection-icon')) empty++;
          });
          if (empty > 0) injectIcons();
        }, 500);
        setTimeout(function() { injectIcons(); }, 1500);
      }
    })();
  </script>

{% schema %}
{
  "name": "Wishlist on collection",
  "target": "section",
  "enabled_on": { "templates": ["collection"] },
  "settings": []
}
{% endschema %}
