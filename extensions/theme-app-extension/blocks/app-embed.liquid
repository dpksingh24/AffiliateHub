{% comment %}
  Kiscience App Embed
  Automatically modifies native Shopify price display based on pricing rules
  Works like Massy - just enable in App Embeds, no blocks needed
{% endcomment %}

{% assign pricing_rules_metafield = shop.metafields.kiscience.pricing_rules %}

<script id="kiscience-config" type="application/json">
{
  "shop": "{{ shop.permanent_domain }}",
  "customerId": {% if customer %}"{{ customer.id }}"{% else %}null{% endif %},
  "customerLoggedIn": {% if customer %}true{% else %}false{% endif %},
  "customerTags": {% if customer %}{{ customer.tags | json }}{% else %}[]{% endif %},
  "currency": "{{ cart.currency.iso_code | default: shop.currency }}"
}
</script>

{% if pricing_rules_metafield != blank %}
<script id="kiscience-rules" type="application/json">
{{ pricing_rules_metafield }}
</script>
{% endif %}

<style>
  /* Kiscience Custom Pricing - Side by side display like Massy */
  .kiscience-active {
    display: flex !important;
    flex-wrap: wrap !important;
    align-items: baseline !important;
  }
  
  /* Hide hidden price elements */
  .kiscience-active .price__current--hidden,
  .kiscience-active .price__compare-at--hidden {
    display: none !important;
  }
  
  /* Show and style the compare-at (original) price - strikethrough, gray, bold */
  .kiscience-active .price__compare-at {
    display: inline-block !important;
    order: 1 !important;
    text-decoration: none !important;
    /* margin-right: 1em !important; */
  }
  
  .kiscience-active .price__compare-at .money,
  .kiscience-active [data-price-compare] {
    text-decoration: line-through !important;
    text-decoration-thickness: 2px !important;
    text-decoration-color: #888 !important;
    color: #888 !important;
    font-size: 36px !important;
    font-weight: 700 !important;
  }
  
  /* Remove any duplicate strikethrough from parent elements */
  .kiscience-active .price__compare-at--single,
  .kiscience-active .price__compare-at span {
    text-decoration: inherit !important;
  }
  
  /* Style the current (custom) price - red, bold, large */
  .kiscience-active .price__current {
    display: inline-block !important;
    order: 2 !important;
  }
  
  .kiscience-active .price__current .money,
  .kiscience-active [data-price] {
    color: #dc2626 !important;
    font-weight: 700 !important;
    font-size: 36px !important;
    text-decoration: none !important;
  }
  
  /* Hide other elements in kiscience-active container */
  .kiscience-active .product__badge,
  .kiscience-active .price__unit-price {
    display: none !important;
  }
  
  /* Generic styling for other themes */
  .kiscience-original-price {
    text-decoration: line-through !important;
    text-decoration-thickness: 2px !important;
    text-decoration-color: #888 !important;
    color: #888 !important;
    margin-right: 20px !important;
    font-size: 36px !important;
    font-weight: 700 !important;
  }
  
  .kiscience-custom-price {
    color: #dc2626 !important;
    font-weight: 700 !important;
    font-size: 36px !important;
    text-decoration: none !important;
  }
  
  /* Kiscience inline price wrapper */
  .kiscience-price-inline {
    display: inline-flex !important;
    align-items: baseline !important;
  }
  
  /* Cart item pricing styles */
  .cart-item .kiscience-compare-price,
  .cart__item .kiscience-compare-price,
  [data-cart-item] .kiscience-compare-price {
    text-decoration: line-through !important;
    text-decoration-thickness: 2px !important;
    text-decoration-color: #888 !important;
    color: #888 !important;
    margin-right: 10px !important;
    font-size: inherit !important;
  }
  
  .cart-item .kiscience-custom-price,
  .cart__item .kiscience-custom-price,
  [data-cart-item] .kiscience-custom-price {
    color: #dc2626 !important;
    font-weight: 700 !important;
    text-decoration: none !important;
  }
</style>

<script>
(function() {
  'use strict';
  
  // Parse config and rules
  var configEl = document.getElementById('kiscience-config');
  var rulesEl = document.getElementById('kiscience-rules');
  
  var config = configEl ? JSON.parse(configEl.textContent) : {};
  var rules = rulesEl ? JSON.parse(rulesEl.textContent) : [];
  
  // Make available globally
  window.KiscienceConfig = config;
  window.KisciencePricingRules = rules;
  
  console.log('Kiscience: Loaded', rules.length, 'pricing rules');
  console.log('Kiscience: Rules data:', JSON.stringify(rules, null, 2));
  console.log('Kiscience: Config:', JSON.stringify(config, null, 2));
  
  if (!rules.length) {
    console.log('Kiscience: No pricing rules found in metafield');
    return;
  }

  // Format money based on currency
  function formatMoney(amount, currency) {
    var formatted = parseFloat(amount).toFixed(2);
    switch (currency || config.currency || 'GBP') {
      case 'GBP': return '£' + formatted;
      case 'EUR': return '€' + formatted;
      case 'USD': return '$' + formatted;
      default: return currency + ' ' + formatted;
    }
  }

  // Check if customer matches rule
  function customerMatches(rule) {
    switch (rule.applyToCustomers) {
      case 'all':
        return true;
      case 'logged_in':
        return config.customerLoggedIn;
      case 'non_logged_in':
        return !config.customerLoggedIn;
      case 'specific':
        if (!config.customerLoggedIn || !rule.specificCustomers) return false;
        return rule.specificCustomers.some(function(c) {
          return String(c.id) === String(config.customerId);
        });
      case 'customer_tags':
        if (!config.customerLoggedIn || !rule.customerTags) return false;
        return rule.customerTags.some(function(tag) {
          return (config.customerTags || []).indexOf(tag) !== -1;
        });
      default:
        return false;
    }
  }

  // Check if product matches rule
  function productMatches(rule, productId, variantId, productTags, productCollections) {
    var productIdNum = String(productId).replace(/\D/g, '');
    var variantIdNum = String(variantId).replace(/\D/g, '');
    
    console.log('Kiscience: Checking product', productIdNum, 'against rule', rule.name);
    
    switch (rule.applyToProducts) {
      case 'all':
        return true;
      case 'specific_products':
        if (!rule.specificProducts) return false;
        var match = rule.specificProducts.some(function(p) {
          return String(p.id) === productIdNum;
        });
        console.log('Kiscience: Specific products match:', match, rule.specificProducts.map(function(p) { return p.id; }));
        return match;
      case 'specific_variants':
        if (!rule.specificVariants) return false;
        return rule.specificVariants.some(function(v) {
          return String(v.id) === variantIdNum;
        });
      case 'collections':
        if (!rule.collections || !productCollections) return false;
        return rule.collections.some(function(c) {
          return productCollections.indexOf(String(c.id)) !== -1;
        });
      case 'product_tags':
        if (!rule.productTags || !productTags) return false;
        return rule.productTags.some(function(tag) {
          return productTags.indexOf(tag) !== -1;
        });
      default:
        return false;
    }
  }

  // Calculate custom price
  function calculatePrice(rule, originalPrice) {
    var discount = parseFloat(rule.discountValue);
    switch (rule.priceType) {
      case 'percent_off':
        return originalPrice * (1 - discount / 100);
      case 'amount_off':
        return Math.max(0, originalPrice - discount);
      case 'new_price':
        return discount;
      default:
        return originalPrice;
    }
  }

  // Find matching rule for product
  function findMatchingRule(productId, variantId, productTags, productCollections) {
    for (var i = 0; i < rules.length; i++) {
      var rule = rules[i];
      if (rule.status !== 'active') continue;
      if (customerMatches(rule) && productMatches(rule, productId, variantId, productTags, productCollections)) {
        console.log('Kiscience: Found matching rule:', rule.name);
        return rule;
      }
    }
    return null;
  }

  // Extract price from text
  function extractPrice(text) {
    if (!text) return null;
    var match = text.match(/[\d,]+\.?\d*/);
    if (match) {
      return parseFloat(match[0].replace(/,/g, ''));
    }
    return null;
  }

  // Get product data from the page
  function getProductData() {
    var data = {
      productId: null,
      variantId: null,
      productTags: [],
      productCollections: []
    };

    // Method 1: Look for product JSON (common in many themes)
    var scripts = document.querySelectorAll('script[type="application/json"]');
    scripts.forEach(function(script) {
      try {
        var json = JSON.parse(script.textContent);
        if (json && json.id && (json.variants || json.title)) {
          data.productId = json.id;
          data.variantId = json.selected_variant ? json.selected_variant.id : 
                          (json.variants && json.variants[0] ? json.variants[0].id : null);
          data.productTags = json.tags || [];
        }
      } catch (e) {}
    });

    // Method 2: From form input
    if (!data.productId) {
      var productInput = document.querySelector('form[action*="/cart/add"] input[name="product-id"], input[data-product-id]');
      if (productInput) {
        data.productId = productInput.value || productInput.dataset.productId;
      }
    }

    // Method 3: From data attributes
    if (!data.productId) {
      var productEl = document.querySelector('[data-product-id]');
      if (productEl) {
        data.productId = productEl.dataset.productId;
      }
    }

    // Method 4: From meta tags
    if (!data.productId) {
      var metaProduct = document.querySelector('meta[property="og:id"], meta[property="product:id"]');
      if (metaProduct) {
        data.productId = metaProduct.content;
      }
    }
    
    // Method 5: Look in window object (many themes expose this)
    if (!data.productId && window.product) {
      data.productId = window.product.id;
      data.productTags = window.product.tags || [];
    }
    
    if (!data.productId && window.ShopifyAnalytics && window.ShopifyAnalytics.meta && window.ShopifyAnalytics.meta.product) {
      data.productId = window.ShopifyAnalytics.meta.product.id;
    }

    // Get variant from select or URL
    var variantSelect = document.querySelector('select[name="id"], input[name="id"]:checked, input[name="id"][type="hidden"]');
    if (variantSelect) {
      data.variantId = variantSelect.value;
    }
    if (!data.variantId) {
      var urlParams = new URLSearchParams(window.location.search);
      data.variantId = urlParams.get('variant');
    }

    console.log('Kiscience: Product data:', data);
    return data;
  }

  // Apply custom pricing to price elements
  function applyCustomPricing() {
    var productData = getProductData();
    if (!productData.productId) {
      console.log('Kiscience: No product ID found on page');
      return;
    }

    var rule = findMatchingRule(
      productData.productId,
      productData.variantId,
      productData.productTags,
      productData.productCollections
    );

    if (!rule) {
      console.log('Kiscience: No matching rule for this product/customer');
      return;
    }

    // Get original price from stored value or from a clean source
    var originalPrice = window.KiscienceOriginalPrice;
    
    if (!originalPrice) {
      // Try to get from hidden price element first (more reliable)
      var hiddenPriceEl = document.querySelector('[data-current-price-hidden] [data-price]');
      if (hiddenPriceEl) {
        originalPrice = extractPrice(hiddenPriceEl.textContent);
      }
      
      // Fallback to visible price
      if (!originalPrice) {
        var visiblePriceEl = document.querySelector('.price__current [data-price], .price__current .money');
        if (visiblePriceEl) {
          originalPrice = extractPrice(visiblePriceEl.textContent);
        }
      }
      
      if (!originalPrice) {
        console.log('Kiscience: Could not extract original price');
        return;
      }
      
      // Store original price
      window.KiscienceOriginalPrice = originalPrice;
    }

    var customPrice = calculatePrice(rule, originalPrice);
    console.log('Kiscience: Rule priceType:', rule.priceType);
    console.log('Kiscience: Rule discountValue:', rule.discountValue);
    console.log('Kiscience: Original price:', originalPrice);
    console.log('Kiscience: Calculated custom price:', customPrice);

    // Find all price containers and update them
    var priceContainers = document.querySelectorAll('.price.product__price, .product-pricing .price');
    
    priceContainers.forEach(function(container) {
      // Skip if already processed
      if (container.classList.contains('kiscience-processed')) return;
      container.classList.add('kiscience-processed');
      container.classList.add('kiscience-active');
      
      // Update compare-at (strikethrough) price
      var compareEls = container.querySelectorAll('[data-price-compare], .price__compare-at .money');
      compareEls.forEach(function(el) {
        el.textContent = formatMoney(originalPrice);
      });
      
      // Show compare price container
      var compareContainer = container.querySelector('.price__compare-at');
      if (compareContainer) {
        compareContainer.style.display = 'block';
        compareContainer.style.visibility = 'visible';
      }
      
      // Update current price
      var currentEls = container.querySelectorAll('[data-price], .price__current .money');
      currentEls.forEach(function(el) {
        // Don't update compare price elements
        if (!el.closest('.price__compare-at') && !el.hasAttribute('data-price-compare')) {
          el.textContent = formatMoney(customPrice);
        }
      });
    });

    // Also update ALL visible price elements on the page with data-price attribute
    document.querySelectorAll('[data-price]').forEach(function(el) {
      if (!el.closest('.price__compare-at') && !el.hasAttribute('data-price-compare')) {
        el.textContent = formatMoney(customPrice);
        console.log('Kiscience: Updated price element:', el);
      }
    });

    // Update ALL compare prices
    document.querySelectorAll('[data-price-compare]').forEach(function(el) {
      el.textContent = formatMoney(originalPrice);
    });

    // Store applied rule globally
    window.KiscienceAppliedRule = rule;
    window.KiscienceCustomPrice = customPrice;
    window.KisciencePricingApplied = true;
    
    console.log('Kiscience: Custom pricing applied successfully!');
  }

  // Apply custom pricing to cart items
  function applyCustomPricingToCart() {
    // Get cart items - try multiple selectors for different themes
    var cartItems = document.querySelectorAll('.cart-item, .cart__item, [data-cart-item], .cart-item-row, .line-item');
    
    if (cartItems.length === 0) {
      console.log('Kiscience: No cart items found');
      return;
    }

    console.log('Kiscience: Found', cartItems.length, 'cart items');

    cartItems.forEach(function(item, index) {
      // Skip if already processed
      if (item.classList.contains('kiscience-processed')) return;
      item.classList.add('kiscience-processed');

      // Try to get product ID and variant ID from various sources
      var productId = null;
      var variantId = null;
      var productTags = [];
      var productCollections = [];

      // Method 1: From data attributes
      productId = item.getAttribute('data-product-id') || item.getAttribute('data-product_id');
      variantId = item.getAttribute('data-variant-id') || item.getAttribute('data-variant_id');

      // Method 2: From hidden inputs
      if (!productId) {
        var productInput = item.querySelector('input[name="product_id"], input[name="product-id"], input[data-product-id]');
        if (productInput) {
          productId = productInput.value || productInput.getAttribute('data-product-id');
        }
      }

      if (!variantId) {
        var variantInput = item.querySelector('input[name="variant_id"], input[name="variant-id"], input[name="id"]');
        if (variantInput) {
          variantId = variantInput.value || variantInput.getAttribute('data-variant-id');
        }
      }

      // Method 3: From cart JSON (if available)
      if (!productId && window.cart && window.cart.items && window.cart.items[index]) {
        var cartItem = window.cart.items[index];
        productId = cartItem.product_id;
        variantId = cartItem.variant_id;
      }

      // Method 4: From Shopify cart object
      if (!productId && window.Shopify && window.Shopify.cart && window.Shopify.cart.items && window.Shopify.cart.items[index]) {
        var shopifyCartItem = window.Shopify.cart.items[index];
        productId = shopifyCartItem.product_id;
        variantId = shopifyCartItem.variant_id;
      }

      if (!productId) {
        console.log('Kiscience: Could not find product ID for cart item', index);
        return;
      }

      // Clean IDs (remove non-numeric characters)
      productId = String(productId).replace(/\D/g, '');
      variantId = variantId ? String(variantId).replace(/\D/g, '') : null;

      // Find matching rule
      var rule = findMatchingRule(productId, variantId, productTags, productCollections);

      if (!rule) {
        console.log('Kiscience: No matching rule for cart item', productId);
        return;
      }

      // Get original price from cart item
      var originalPrice = null;
      
      // Try to get from price elements
      var priceEl = item.querySelector('.cart-item__price, .cart__price, [data-cart-item-price], .line-item__price, .price');
      if (priceEl) {
        // Look for compare-at price first (original)
        var comparePriceEl = priceEl.querySelector('[data-price-compare], .price__compare-at .money, .compare-at-price');
        if (comparePriceEl) {
          originalPrice = extractPrice(comparePriceEl.textContent);
        }
        
        // If no compare price, try to get from current price
        if (!originalPrice) {
          var currentPriceEl = priceEl.querySelector('[data-price], .money, .price__current');
          if (currentPriceEl) {
            originalPrice = extractPrice(currentPriceEl.textContent);
          }
        }
      }

      // Fallback: Try to get from cart data
      if (!originalPrice && window.cart && window.cart.items && window.cart.items[index]) {
        originalPrice = parseFloat(window.cart.items[index].price) / 100; // Shopify prices are in cents
      }

      if (!originalPrice && window.Shopify && window.Shopify.cart && window.Shopify.cart.items && window.Shopify.cart.items[index]) {
        originalPrice = parseFloat(window.Shopify.cart.items[index].price) / 100;
      }

      if (!originalPrice) {
        console.log('Kiscience: Could not extract original price for cart item', productId);
        return;
      }

      // Calculate custom price
      var customPrice = calculatePrice(rule, originalPrice);
      console.log('Kiscience: Cart item', productId, '- Original:', originalPrice, 'Custom:', customPrice);

      // Update price display in cart item
      var priceContainer = item.querySelector('.cart-item__price, .cart__price, [data-cart-item-price], .line-item__price, .price');
      if (priceContainer) {
        // Create or update compare-at price (strikethrough)
        var compareContainer = priceContainer.querySelector('.price__compare-at, .compare-at-price, [data-price-compare]');
        if (!compareContainer) {
          // Create compare price element if it doesn't exist
          compareContainer = document.createElement('span');
          compareContainer.className = 'price__compare-at kiscience-compare-price';
          compareContainer.style.textDecoration = 'line-through';
          compareContainer.style.color = '#888';
          compareContainer.style.marginRight = '10px';
          priceContainer.insertBefore(compareContainer, priceContainer.firstChild);
        }
        compareContainer.textContent = formatMoney(originalPrice);
        compareContainer.style.display = 'inline-block';

        // Update current price
        {% comment %} var currentPriceEl = priceContainer.querySelector('[data-price], .money:not(.kiscience-compare-price), .price__current'); {% endcomment %}
        var currentPriceEl = priceContainer.querySelector(
          '[data-price], .money:not(.kiscience-compare-price), .price__current'
        );
        if (currentPriceEl) {
          // Don't update if it's the compare price
          if (!currentPriceEl.closest('.price__compare-at') && !currentPriceEl.classList.contains('kiscience-compare-price')) {
            currentPriceEl.textContent = formatMoney(customPrice);
            currentPriceEl.style.color = '#dc2626';
            currentPriceEl.style.fontWeight = '700';
          }
        } else {
          // Create current price element if it doesn't exist
          var newPriceEl = document.createElement('span');
          newPriceEl.className = 'kiscience-custom-price';
          newPriceEl.textContent = formatMoney(customPrice);
          newPriceEl.style.color = '#dc2626';
          newPriceEl.style.fontWeight = '700';
          priceContainer.appendChild(newPriceEl);
        }
      }

      // Also update line item total if it exists
      var lineTotalEl = item.querySelector('.cart-item__total, .cart__total, [data-cart-item-total], .line-item__total');
      if (lineTotalEl && customPrice !== originalPrice) {
        var quantity = 1;
        var quantityInput = item.querySelector('input[name="quantity"], input[data-quantity]');
        if (quantityInput) {
          quantity = parseInt(quantityInput.value) || 1;
        }
        var lineTotal = customPrice * quantity;
        lineTotalEl.textContent = formatMoney(lineTotal);
      }
    });

    console.log('Kiscience: Cart pricing applied successfully!');
  }

  // Run on page load
  function init() {
    // Check if we're on a product page
    if (window.location.pathname.includes('/products/')) {
      applyCustomPricing();
    }
    
    // Check if we're on a cart page
    if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart') {
      applyCustomPricingToCart();
    }
  }

  // Listen for variant changes on product pages
  document.addEventListener('change', function(e) {
    if (e.target.matches('select[name="id"], input[name="id"]')) {
      // Small delay to let theme update first
      setTimeout(applyCustomPricing, 200);
    }
    
    // Listen for quantity changes in cart
    if (e.target.matches('input[name="quantity"], input[data-quantity]')) {
      if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart') {
        // Reset processed state and re-apply pricing
        document.querySelectorAll('.cart-item, .cart__item, [data-cart-item]').forEach(function(item) {
          item.classList.remove('kiscience-processed');
        });
        setTimeout(applyCustomPricingToCart, 300);
      }
    }
  });

  // Listen for cart updates (AJAX cart updates)
  document.addEventListener('cart:updated', function() {
    if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart') {
      document.querySelectorAll('.cart-item, .cart__item, [data-cart-item]').forEach(function(item) {
        item.classList.remove('kiscience-processed');
      });
      setTimeout(applyCustomPricingToCart, 500);
    }
  });

  // Listen for Shopify cart updates
  if (window.Shopify && window.Shopify.cart) {
    var originalCartUpdate = window.Shopify.cart.update;
    if (originalCartUpdate) {
      window.Shopify.cart.update = function() {
        var result = originalCartUpdate.apply(this, arguments);
        setTimeout(function() {
          if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart') {
            document.querySelectorAll('.cart-item, .cart__item, [data-cart-item]').forEach(function(item) {
              item.classList.remove('kiscience-processed');
            });
            applyCustomPricingToCart();
          }
        }, 500);
        return result;
      };
    }
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(init, 500);
    });
  } else {
    setTimeout(init, 500);
  }
  
  // Also run after full page load for themes that load content dynamically
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (window.location.pathname.includes('/products/')) {
        applyCustomPricing();
      }
      if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart') {
        applyCustomPricingToCart();
      }
    }, 1000);
  });

  // Use MutationObserver to watch for cart updates (for dynamic cart drawers)
  if (typeof MutationObserver !== 'undefined') {
    var cartObserver = new MutationObserver(function(mutations) {
      if (window.location.pathname.includes('/cart') || window.location.pathname === '/cart' || 
          document.querySelector('.cart, .cart-drawer, [data-cart]')) {
        var cartItems = document.querySelectorAll('.cart-item, .cart__item, [data-cart-item]');
        var hasUnprocessed = false;
        cartItems.forEach(function(item) {
          if (!item.classList.contains('kiscience-processed')) {
            hasUnprocessed = true;
          }
        });
        if (hasUnprocessed) {
          setTimeout(applyCustomPricingToCart, 500);
        }
      }
    });
    
    cartObserver.observe(document.body, {
      childList: true,
      subtree: true
    });
  }
})();
</script>

{% schema %}
{
  "name": "Kiscience Custom Pricing",
  "target": "head",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable Custom Pricing",
      "default": true,
      "info": "Automatically applies custom pricing to product pages based on your pricing rules"
    }
  ]
}
{% endschema %}
